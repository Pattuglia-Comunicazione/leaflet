<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-tag-filter-button@0.0.5/src/leaflet-tag-filter-button.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-tag-filter-button@0.0.5/src/leaflet-tag-filter-button.min.css">
</head>
<body>
    <div id="map" style="height: 90vh; width: 90vw; margin-left: auto; margin-right: auto;"></div>

    <script>
        $(document).ready(async function() {
            try {
                const data = await fetchData();
                const regex = /\(([^)]+)\)/;
                const risultato = String(data).match(regex);
                const obj = JSON.parse(risultato[1]);
                const schede = obj['table']['rows'];
                caricaMarkers(schede);
            } catch (error) {
                console.log("Error fetching data:", error);
            }
        });

        async function fetchData() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: "https://zonabaricentrostrutture.giudimax.workers.dev/",
                    dataType: 'text',
                    success: resolve,
                    error: (jqXhr, textStatus, errorMessage) => {
                        reject(errorMessage);
                    },
                });
            });
        }

        function getLonLat(address) {
            const formattedAddress = address.replace(/,/g, '+');
            const url = `https://nominatim.openstreetmap.org/search?q=${formattedAddress}&format=json&polygon=1&addressdetails=1`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = data[0].lat;
                        const lon = data[0].lon;
                        return { lat, lon };
                    } else {
                        console.log("No valid data found for the given address:", formattedAddress);
                        return { lat: null, lon: null };
                    }
                })
                .catch(error => {
                    console.log("Error fetching data:", error.message);
                    return { lat: null, lon: null };
                });
        }

        function caricaMarkers(schede) {
            var map = L.map('map').setView([41.092144, 16.8872818], 11);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Map each schede to an array of promises
            const promises = schede.map(value => {
                value = value['c'];
                if (value[0]['v'] == "ID" || value[0]['v'] == "") { return Promise.resolve(null); }

                var tagsToAppend = [];

                if (value[7]['v'] === 'SI') {
                    tagsToAppend.push('LC');
                }
                if (value[8]['v'] === 'SI') {
                    tagsToAppend.push('EG');
                }
                if (value[9]['v'] === 'SI') {
                    tagsToAppend.push('RS');
                }
                console.log(tagsToAppend);

                var latitude;
                var longitude;

                if (!value[16] || !value[17]) {
                     getLonLat(value[2]['v'])
                        .then(result => {
                            console.log(result);
                            latitude = result.lat;
                            longitude = result.lon;
                            console.log("lat e lon found")
                            var marker = L.marker([latitude, longitude], { tags: tagsToAppend }).addTo(map);

                            marker.bindPopup("<b>" + value[1]['v'] + "</b><br>Luogo: " + value[2]['v'] + "<br>Capienza: " + value[3]['v']);
                            
                        })
                        .catch(error => {
                            console.log("Error fetching latitude and longitude for:", value[2]['v'], error);
                        });
                } else {
                    latitude = value[16]['v'];
                    longitude = value[17]['v'];
                }

                if (latitude && longitude) {
                    var marker = L.marker([latitude, longitude], { tags: tagsToAppend }).addTo(map);

                    marker.bindPopup("<b>" + value[1]['v'] + "</b><br>Luogo: " + value[2]['v'] + "<br>Capienza: " + value[3]['v']);
                }

                return Promise.resolve();
            });

            // Use Promise.all to wait for all promises to resolve
            Promise.all(promises)
                .then(() => {
                    L.control.tagFilterButton({
                        data: ['EG', 'LC', 'RS'],
                        icon: '<img src="images/filter.png" style="width: 20px; height: 20px;">',
                        filterOnEveryClick: true
                    }).addTo(map);
                });
        }
    </script>
</body>
</html>
